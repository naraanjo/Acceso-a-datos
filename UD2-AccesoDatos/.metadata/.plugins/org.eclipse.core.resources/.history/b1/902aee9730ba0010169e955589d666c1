package Veterinario.vet;

import java.util.List;
import clinica_model.Certificacion;
import clinica_model.Veterinario;
import clinica_persistence.CertificacionPersistence;
import clinica_persistence.VeterinarioPersistence;

public class FuncionalidadMenu {

    //  MENÚS PRINCIPALES 

    public static int mostrarMenuPrincipal() {
        System.out.println("\n=== MENÚ PRINCIPAL ===");
        System.out.println("1. Gestión de Veterinarios");
        System.out.println("2. Gestión de Certificaciones");
        System.out.println("3. Mostrar todos los datos del sistema");
        System.out.println("4. Ejecutar pruebas automáticas");
        System.out.println("0. Salir");
        return Libreria.leerEntero("Seleccione una opción: ");
    }

    public static int mostrarMenuVeterinarios() {
        System.out.println("\n=== MENÚ VETERINARIOS ===");
        System.out.println("1. Crear veterinario");
        System.out.println("2. Buscar veterinario por licencia");
        System.out.println("3. Mostrar todos los veterinarios");
        System.out.println("4. Actualizar veterinario");
        System.out.println("5. Eliminar veterinario");
        System.out.println("0. Volver");
        return Libreria.leerEntero("Seleccione una opción: ");
    }

    public static int mostrarMenuCertificaciones() {
        System.out.println("\n=== MENÚ CERTIFICACIONES ===");
        System.out.println("1. Crear certificación");
        System.out.println("2. Buscar certificación por ID");
        System.out.println("3. Mostrar todas las certificaciones");
        System.out.println("4. Buscar certificaciones por veterinario");
        System.out.println("5. Actualizar certificación");
        System.out.println("6. Eliminar certificación");
        System.out.println("0. Volver");
        return Libreria.leerEntero("Seleccione una opción: ");
    }

    // CRUD VETERINARIOS 

    public static void crearVeterinario() {
        System.out.println("\n=== CREAR VETERINARIO ===");
        Veterinario vet = new Veterinario();

        vet.setNum_licencia(Libreria.leerEntero("Número de licencia: "));
        vet.setNombre(Libreria.leerString("Nombre: "));
        vet.setApellido(Libreria.leerString("Apellido: "));
        vet.setFecha_contratacion(Libreria.leerString("Fecha de contratación (YYYY-MM-DD): "));
        vet.setSalarioBase(Libreria.leerDouble("Salario base: "));
        vet.setHorarioSemanal(Libreria.leerDouble("Horas semanales: "));

        if (VeterinarioPersistence.create(vet)) {
            System.out.println("Veterinario creado exitosamente.");

            // Aqui he implementado que a la hora de crear un veterinario, se
            // deba crear una certificacion, ( podria quitar este codigo de abajo ), y 
            // que no se hiciera pero he preferido dejarlo asi.
            // --- Crear certificación asociada ---
            System.out.println("\nAhora ingrese los datos de la certificación del veterinario.");
            Certificacion cert = new Certificacion();
            cert.setVeterinario_licencia(vet.getNum_licencia());
            cert.setInstitucion_emisora(Libreria.leerString("Institución emisora: "));
            cert.setNombre_especialidad(Libreria.leerString("Nombre de especialidad: "));

            if (CertificacionPersistence.create(cert))
                System.out.println("Certificación creada correctamente para el veterinario " + vet.getNombre() + ".");
            else
                System.out.println("Error al crear la certificación asociada.");
        } else {
            System.out.println("Error al crear veterinario.");
        }
    }


    public static void buscarVeterinarioPorLicencia() {
        int licencia = Libreria.leerEntero("\nIngrese número de licencia: ");
        Veterinario vet = VeterinarioPersistence.readById(licencia);

        if (vet != null) {
            System.out.println("\n--- DETALLES VETERINARIO ---");
            VeterinarioPersistence.mostrarDetallesVeterinario(vet);
        } else {
            System.out.println("Veterinario no encontrado.");
        }
    }

    public static void mostrarTodosVeterinarios() {
        List<Veterinario> veterinarios = VeterinarioPersistence.readAll();
        if (veterinarios.isEmpty()) {
            System.out.println("No hay veterinarios registrados.");
        } else {
            System.out.println("\n--- LISTADO DE VETERINARIOS ---");
            veterinarios.forEach(VeterinarioPersistence::mostrarDetallesVeterinario);
        }
    }

    
    public static void actualizarVeterinario() {
        int licencia = Libreria.leerEntero("\nIngrese número de licencia del veterinario a actualizar: ");
        Veterinario vet = VeterinarioPersistence.readById(licencia);

        if (vet == null) {
            System.out.println("Veterinario no encontrado.");
            return;
        }

        System.out.println("\n=== ACTUALIZAR VETERINARIO ===");
        System.out.println("Veterinario actual:");
        VeterinarioPersistence.mostrarDetallesVeterinario(vet);
        
        System.out.println("\n--- DATOS PERSONALES ---");
        String nuevoNombre = Libreria.leerStringOpcional("Nuevo nombre (" + vet.getNombre() + "): ");
        if (!nuevoNombre.isBlank()) vet.setNombre(nuevoNombre);

        String nuevoApellido = Libreria.leerStringOpcional("Nuevo apellido (" + vet.getApellido() + "): ");
        if (!nuevoApellido.isBlank()) vet.setApellido(nuevoApellido);

        String nuevaFecha = Libreria.leerStringOpcional("Nueva fecha contratación (" + vet.getFecha_contratacion() + "): ");
        if (!nuevaFecha.isBlank()) vet.setFecha_contratacion(nuevaFecha);

        System.out.println("\n--- DATOS LABORALES ---");
        Double nuevoSalario = Libreria.leerDoubleOpcional("Nuevo salario base (" + vet.getSalarioBase() + "): ");
        if (nuevoSalario != null) vet.setSalarioBase(nuevoSalario);

        Double nuevoHorario = Libreria.leerDoubleOpcional("Nuevo horario semanal (" + vet.getHorarioSemanal() + "): ");
        if (nuevoHorario != null) vet.setHorarioSemanal(nuevoHorario);

        System.out.println("\n--- GESTIÓN DE CERTIFICACIONES ---");
        gestionarCertificacionesVeterinario(vet);

        // Actualizar en la base de datos
        if (VeterinarioPersistence.update(vet)) {
            System.out.println("✅ Veterinario actualizado correctamente.");
        } else {
            System.out.println("❌ Error al actualizar veterinario.");
        }
    }

    // Método auxiliar para gestionar certificaciones durante la actualización
    private static void gestionarCertificacionesVeterinario(Veterinario vet) {
        List<Certificacion> certificacionesActuales = CertificacionPersistence.readByVeterinarioLicencia(vet.getNum_licencia());
        
        if (!certificacionesActuales.isEmpty()) {
            System.out.println("\nCertificaciones actuales:");
            for (int i = 0; i < certificacionesActuales.size(); i++) {
                Certificacion c = certificacionesActuales.get(i);
                System.out.println("  " + (i + 1) + ". " + c.getNombre_especialidad() + " - " + c.getInstitucion_emisora() + " (ID: " + c.getId() + ")");
            }
        } else {
            System.out.println("No hay certificaciones registradas.");
        }

        int opcionCert;
        do {
            System.out.println("\n--- OPCIONES CERTIFICACIONES ---");
            System.out.println("1. Añadir nueva certificación");
            System.out.println("2. Eliminar certificación existente");
            System.out.println("0. Volver a actualización del veterinario");
            
            opcionCert = Libreria.leerEntero("Seleccione una opción: ");
            
            switch (opcionCert) {
                case 1 -> añadirCertificacionVeterinario(vet);
                case 2 -> eliminarCertificacionVeterinario(certificacionesActuales);
                case 0 -> System.out.println("Continuando con la actualización...");
                default -> System.out.println("Opción no válida.");
            }
        } while (opcionCert != 0);
    }

    // Método para añadir certificación durante actualización
    private static void añadirCertificacionVeterinario(Veterinario vet) {
        System.out.println("\n--- AÑADIR NUEVA CERTIFICACIÓN ---");
        Certificacion cert = new Certificacion();
        cert.setVeterinario_licencia(vet.getNum_licencia());
        cert.setInstitucion_emisora(Libreria.leerString("Institución emisora: "));
        cert.setNombre_especialidad(Libreria.leerString("Nombre de especialidad: "));

        if (CertificacionPersistence.create(cert)) {
            System.out.println("✅ Certificación añadida correctamente.");
        } else {
            System.out.println("❌ Error al añadir certificación.");
        }
    }

    // Método para eliminar certificación durante actualización
    private static void eliminarCertificacionVeterinario(List<Certificacion> certificaciones) {
        if (certificaciones.isEmpty()) {
            System.out.println("No hay certificaciones para eliminar.");
            return;
        }

        System.out.println("\n--- ELIMINAR CERTIFICACIÓN ---");
        for (int i = 0; i < certificaciones.size(); i++) {
            Certificacion c = certificaciones.get(i);
            System.out.println((i + 1) + ". " + c.getNombre_especialidad() + " - " + c.getInstitucion_emisora() + " (ID: " + c.getId() + ")");
        }

        int seleccion = Libreria.leerEntero("Seleccione el número de certificación a eliminar (0 para cancelar): ");
        
        if (seleccion == 0) {
            System.out.println("Operación cancelada.");
            return;
        }

        if (seleccion > 0 && seleccion <= certificaciones.size()) {
            Certificacion certAEliminar = certificaciones.get(seleccion - 1);
            boolean confirmar = Libreria.leerSiNo("¿Está seguro de eliminar la certificación '" + 
                certAEliminar.getNombre_especialidad() + "'? (s/n): ");
            
            if (confirmar) {
                if (CertificacionPersistence.delete(certAEliminar.getId())) {
                    System.out.println("✅ Certificación eliminada correctamente.");
                    certificaciones.remove(seleccion - 1); // Actualizar lista local
                } else {
                    System.out.println("❌ Error al eliminar certificación.");
                }
            } else {
                System.out.println("Eliminación cancelada.");
            }
        } else {
            System.out.println("Selección no válida.");
        }
    }

    public static void eliminarVeterinario() {
        int licencia = Libreria.leerEntero("\nIngrese número de licencia del veterinario a eliminar: ");
        
        // Verificar existencia primero (opcional, para mejor UX)
        Veterinario vet = VeterinarioPersistence.readById(licencia);
        if (vet == null) {
            System.out.println("No existe un veterinario con la licencia especificada.");
            return;
        }

        // Confirmación de eliminación
        System.out.println("\nVeterinario a eliminar:");
        System.out.println("Licencia: " + vet.getNum_licencia());
        System.out.println("Nombre: " + vet.getNombre() + " " + vet.getApellido());
        
        boolean confirmar = Libreria.leerSiNo("¿Está seguro de que desea eliminar este veterinario? (s/n): ");
        
        if (!confirmar) {
            System.out.println("Eliminación cancelada.");
            return;
        }

        // Una sola llamada que maneja TODO en una transacción
        if (VeterinarioPersistence.delete(licencia)) {
            System.out.println("Veterinario eliminado exitosamente junto con sus certificaciones y contrato.");
        } else {
            System.out.println("Error al eliminar veterinario.");
        }
    }

    // CRUD CERTIFICACIONES 

    public static void crearCertificacion() {
        System.out.println("\n=== CREAR CERTIFICACIÓN ===");
        Certificacion cert = new Certificacion();

        cert.setInstitucion_emisora(Libreria.leerString("Institución emisora: "));
        cert.setNombre_especialidad(Libreria.leerString("Nombre de especialidad: "));
        int licencia = Libreria.leerEntero("Licencia del veterinario: ");
        cert.setVeterinario_licencia(licencia);

        Veterinario vet = VeterinarioPersistence.readById(licencia);
        if (vet == null) {
            System.out.println("Error: No existe un veterinario con licencia " + licencia);
            return;
        }

        if (CertificacionPersistence.create(cert))
            System.out.println("Certificación creada con ID: " + cert.getId());
        else
            System.out.println("Error al crear certificación.");
    }

    public static void buscarCertificacionPorId() {
        int id = Libreria.leerEntero("\nIngrese ID de certificación: ");
        Certificacion cert = CertificacionPersistence.readById(id);

        if (cert != null)
            CertificacionPersistence.mostrarDetallesCertificacion(cert);
        else
            System.out.println("Certificación no encontrada.");
    }

    public static void mostrarTodasCertificaciones() {
        List<Certificacion> lista = CertificacionPersistence.readAll();
        if (lista.isEmpty()) {
            System.out.println("No hay certificaciones registradas.");
        } else {
            System.out.println("\n--- TODAS LAS CERTIFICACIONES ---");
            lista.forEach(CertificacionPersistence::mostrarDetallesCertificacion);
        }
    }

    public static void buscarCertificacionesPorVeterinario() {
        int licencia = Libreria.leerEntero("\nIngrese número de licencia del veterinario: ");
        List<Certificacion> lista = CertificacionPersistence.readByVeterinarioLicencia(licencia);

        if (lista.isEmpty())
            System.out.println("No se encontraron certificaciones para este veterinario.");
        else
            lista.forEach(CertificacionPersistence::mostrarDetallesCertificacion);
    }

    public static void actualizarCertificacion() {
        int id = Libreria.leerEntero("\nIngrese ID de certificación a actualizar: ");
        Certificacion cert = CertificacionPersistence.readById(id);

        if (cert == null) {
            System.out.println("Certificación no encontrada.");
            return;
        }

        String nuevaInst = Libreria.leerStringOpcional("Nueva institución (" + cert.getInstitucion_emisora() + "): ");
        if (!nuevaInst.isBlank()) cert.setInstitucion_emisora(nuevaInst);

        String nuevaEsp = Libreria.leerStringOpcional("Nueva especialidad (" + cert.getNombre_especialidad() + "): ");
        if (!nuevaEsp.isBlank()) cert.setNombre_especialidad(nuevaEsp);

        if (CertificacionPersistence.update(cert))
            System.out.println("Certificación actualizada correctamente.");
        else
            System.out.println("Error al actualizar certificación.");
    }

    public static void eliminarCertificacion() {
        int id = Libreria.leerEntero("\nIngrese ID de certificación a eliminar: ");
        if (CertificacionPersistence.delete(id))
            System.out.println("Certificación eliminada exitosamente.");
        else
            System.out.println("Error al eliminar certificación.");
    }

    // BD COMPLETA 

    public static void mostrarTodosLosDatos() {
        System.out.println("\n=== DATOS DEL SISTEMA ===");
        mostrarTodosVeterinarios();
        mostrarTodasCertificaciones();
    }
    
    // MÉTODO PARA LIMPIAR LA BASE DE DATOS
    public static void limpiarBD() {


        // Mostrar estadísticas actuales
        List<Veterinario> veterinarios = VeterinarioPersistence.readAll();
        List<Certificacion> certificaciones = CertificacionPersistence.readAll();

        
        try {
            // Obtener todos los veterinarios para eliminarlos individualmente
      
            int veterinariosEliminados = 0;
            int certificacionesEliminadas = 0;
            
            for (Veterinario vet : veterinarios) {
                if (VeterinarioPersistence.delete(vet.getNum_licencia())) {
                    veterinariosEliminados++;
                    // Las certificaciones se eliminan automáticamente en VeterinarioPersistence.delete
                    certificacionesEliminadas += CertificacionPersistence.readByVeterinarioLicencia(vet.getNum_licencia()).size();
                }
            }
   
            // Verificación final
            List<Veterinario> veterinariosRestantes = VeterinarioPersistence.readAll();
            List<Certificacion> certificacionesRestantes = CertificacionPersistence.readAll();
            
            if (veterinariosRestantes.isEmpty() && certificacionesRestantes.isEmpty()) {
                System.out.println(" Base de datos completamente vacía.");
            } 
            
        } catch (Exception e) {
            System.out.println("rror durante la limpieza: " + e.getMessage());
           
        }
    }

}
